<!DOCTYPE html>
<html>
<head>
  <title>Fetch MP3 in Chunks</title>
</head>
<body>
  <audio controls id="audio-player"></audio>

  <script>
    const audioPlayer = document.getElementById('audio-player');

    // Fetch the MP3 file in chunks
    async function fetchMP3Chunks() {
      const url = 'http://localhost:3000/song/1'; // Replace with the appropriate server URL

      try {
        const response = await fetch(url, {
          headers: { Range: 'bytes=0-' }, // Request the first chunk
        });

        if (!response.ok) {
          console.error('Error:', response.statusText);
          return;
        }

        const contentRange = response.headers.get('Content-Range');
        const totalSize = parseInt(contentRange.split('/')[1]);

        // Initialize a media source object
        const mediaSource = new MediaSource();
        audioPlayer.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener('sourceopen', async () => {
          const sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');

          let receivedBytes = 0;

          sourceBuffer.addEventListener('updateend', async () => {
            if (receivedBytes < totalSize) {
              const endByte = Math.min(receivedBytes + 1024 * 1024, totalSize - 1);
              const rangeHeader = `bytes=${receivedBytes}-${endByte}`;

              const chunkResponse = await fetch(url, {
                headers: { Range: rangeHeader },
              });

              if (!chunkResponse.ok) {
                console.error('Error:', chunkResponse.statusText);
                return;
              }

              const chunk = await chunkResponse.arrayBuffer();
              sourceBuffer.appendBuffer(chunk);
              receivedBytes = endByte + 1;

              // If you want to play immediately, uncomment the following line
              // if (!audioPlayer.paused) audioPlayer.play();

              // Continue fetching more chunks until the entire file is buffered
              if (receivedBytes < totalSize) {
                fetchMP3Chunks();
              }
            }
          });

          // Start playback once the first chunk is appended
          audioPlayer.play();
        });
      } catch (error) {
        console.error('Fetch error:', error);
      }
    }

    // Start fetching and streaming the MP3 file
    fetchMP3Chunks();
  </script>
</body>
</html>
